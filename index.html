<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Knitting Counter</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- iOS home screen support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Knitting Counter">

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    button {
      font-size: 20px;
      padding: 10px 20px;
      margin: 5px;
    }
    .row-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
      gap: 10px;
    }
    .row-controls {
      display: flex;
      gap: 5px;
    }
    .row-controls button {
      font-size: 16px;
      padding: 5px 12px;
    }
    .row-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .row-label {
      min-width: 150px;
    }
    .row-name {
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 3px;
    }
    .row-name:hover {
      background-color: #e0e0e0;
    }
    .row-name-input {
      font-size: inherit;
      font-weight: bold;
      width: 100px;
      padding: 2px 5px;
    }
    .drag-handle {
      cursor: grab;
      padding: 5px 8px;
      color: #666;
      font-size: 18px;
      user-select: none;
      touch-action: none;
    }
    .drag-handle:hover {
      color: #333;
    }
    .drag-handle:active {
      cursor: grabbing;
    }
    .row-container.dragging {
      opacity: 0.5;
      background-color: #f0f0f0;
    }
    .row-container.drag-over {
      border-top: 2px solid #007bff;
    }
    .stopwatch {
      margin: 20px 0;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
      display: inline-block;
    }
    .stopwatch-display {
      font-size: 32px;
      font-family: monospace;
      margin-bottom: 10px;
    }
    .stopwatch button {
      font-size: 16px;
      padding: 8px 16px;
    }
    .project-name {
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
    }
    .project-name:hover {
      background-color: #e0e0e0;
    }
    .project-name-input {
      font-size: inherit;
      font-weight: bold;
      font-family: inherit;
      padding: 5px 10px;
      width: 300px;
    }
  </style>
</head>
<body>
  <h1><span id="project-name" class="project-name" title="Double-click to rename">Knitting Counter</span></h1>

  <div class="stopwatch">
    <div class="stopwatch-display" id="stopwatch-display">00:00:00</div>
    <button id="stopwatch-btn" onclick="toggleStopwatch()">Start</button>
  </div>

  <div id="rows-container"></div>

  <script>
    // Project name - editable and persistent
    let projectName = localStorage.getItem('projectName') || 'Knitting Counter';
    
    function updateProjectName() {
      const nameEl = document.getElementById('project-name');
      nameEl.textContent = projectName;
      document.title = projectName;
    }

    function editProjectName() {
      const nameEl = document.getElementById('project-name');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'project-name-input';
      input.value = projectName;
      
      const saveName = () => {
        projectName = input.value.trim() || 'Knitting Counter';
        localStorage.setItem('projectName', projectName);
        const span = document.createElement('span');
        span.id = 'project-name';
        span.className = 'project-name';
        span.title = 'Double-click to rename';
        span.textContent = projectName;
        span.ondblclick = editProjectName;
        input.replaceWith(span);
        document.title = projectName;
      };
      
      input.onblur = saveName;
      input.onkeydown = (e) => {
        if (e.key === 'Enter') {
          saveName();
        } else if (e.key === 'Escape') {
          const span = document.createElement('span');
          span.id = 'project-name';
          span.className = 'project-name';
          span.title = 'Double-click to rename';
          span.textContent = projectName;
          span.ondblclick = editProjectName;
          input.replaceWith(span);
        }
      };
      
      nameEl.replaceWith(input);
      input.focus();
      input.select();
    }

    // Initialize project name
    updateProjectName();
    document.getElementById('project-name').ondblclick = editProjectName;

    // Stopwatch - persistent, only goes up
    let stopwatchElapsed = parseInt(localStorage.getItem('stopwatchElapsed') || '0');
    let stopwatchRunning = localStorage.getItem('stopwatchRunning') === 'true';
    let stopwatchStartTime = parseInt(localStorage.getItem('stopwatchStartTime') || '0');
    let stopwatchInterval = null;

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return [
        hours.toString().padStart(2, '0'),
        minutes.toString().padStart(2, '0'),
        seconds.toString().padStart(2, '0')
      ].join(':');
    }

    function updateStopwatchDisplay() {
      let currentElapsed = stopwatchElapsed;
      if (stopwatchRunning) {
        currentElapsed += Date.now() - stopwatchStartTime;
      }
      document.getElementById('stopwatch-display').textContent = formatTime(currentElapsed);
      document.getElementById('stopwatch-btn').textContent = stopwatchRunning ? 'Stop' : 'Start';
    }

    function toggleStopwatch() {
      if (stopwatchRunning) {
        // Stop
        stopwatchElapsed += Date.now() - stopwatchStartTime;
        stopwatchRunning = false;
        clearInterval(stopwatchInterval);
        localStorage.setItem('stopwatchElapsed', stopwatchElapsed);
        localStorage.setItem('stopwatchRunning', 'false');
      } else {
        // Start
        stopwatchStartTime = Date.now();
        stopwatchRunning = true;
        localStorage.setItem('stopwatchStartTime', stopwatchStartTime);
        localStorage.setItem('stopwatchRunning', 'true');
        stopwatchInterval = setInterval(updateStopwatchDisplay, 1000);
      }
      updateStopwatchDisplay();
    }

    // Initialize stopwatch
    if (stopwatchRunning) {
      stopwatchInterval = setInterval(updateStopwatchDisplay, 1000);
    }
    updateStopwatchDisplay();

    // Load saved progress - migrate old format if needed
    let rows = JSON.parse(localStorage.getItem('rows') || 'null');
    if (!rows) {
      rows = [{ name: 'Row 1', count: 0 }];
    } else if (typeof rows[0] === 'number') {
      // Migrate old format (array of numbers) to new format (array of objects)
      rows = rows.map((count, i) => ({ name: `Row ${i + 1}`, count }));
    }

    function updateDisplay() {
      const container = document.getElementById('rows-container');
      container.innerHTML = '';
      
      rows.forEach((row, index) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row-container';
        rowDiv.draggable = true;
        rowDiv.dataset.index = index;
        
        // Drag events
        rowDiv.ondragstart = (e) => {
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', index);
          rowDiv.classList.add('dragging');
          draggedIndex = index;
        };
        rowDiv.ondragend = () => {
          rowDiv.classList.remove('dragging');
          draggedIndex = null;
          document.querySelectorAll('.row-container').forEach(el => el.classList.remove('drag-over'));
        };
        rowDiv.ondragover = (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          const target = e.currentTarget;
          document.querySelectorAll('.row-container').forEach(el => el.classList.remove('drag-over'));
          if (draggedIndex !== index) {
            target.classList.add('drag-over');
          }
        };
        rowDiv.ondragleave = () => {
          rowDiv.classList.remove('drag-over');
        };
        rowDiv.ondrop = (e) => {
          e.preventDefault();
          const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
          const toIndex = index;
          if (fromIndex !== toIndex) {
            moveRow(fromIndex, toIndex);
          }
          document.querySelectorAll('.row-container').forEach(el => el.classList.remove('drag-over'));
        };
        
        // Drag handle
        const dragHandle = document.createElement('span');
        dragHandle.className = 'drag-handle';
        dragHandle.textContent = 'â˜°';
        dragHandle.title = 'Drag to reorder';
        
        const label = document.createElement('span');
        label.className = 'row-label';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'row-name';
        nameSpan.textContent = row.name;
        nameSpan.title = 'Double-click to rename';
        nameSpan.ondblclick = () => editRowName(index, nameSpan);
        
        const countSpan = document.createElement('span');
        countSpan.textContent = `: ${row.count}`;
        
        label.appendChild(nameSpan);
        label.appendChild(countSpan);
        
        const countControls = document.createElement('div');
        countControls.className = 'row-controls';
        
        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+1';
        plusBtn.onclick = () => changeCount(index, 1);
        
        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-1';
        minusBtn.onclick = () => changeCount(index, -1);
        
        countControls.appendChild(plusBtn);
        countControls.appendChild(minusBtn);
        
        const rowControls = document.createElement('div');
        rowControls.className = 'row-controls';
        
        const addRowBtn = document.createElement('button');
        addRowBtn.textContent = '+ Row';
        addRowBtn.onclick = () => addRow(index);
        
        const removeRowBtn = document.createElement('button');
        removeRowBtn.textContent = '- Row';
        removeRowBtn.onclick = () => removeRow(index);
        removeRowBtn.disabled = rows.length <= 1;
        
        rowControls.appendChild(addRowBtn);
        rowControls.appendChild(removeRowBtn);
        
        rowDiv.appendChild(dragHandle);
        rowDiv.appendChild(label);
        rowDiv.appendChild(countControls);
        rowDiv.appendChild(rowControls);
        container.appendChild(rowDiv);
      });
    }

    let draggedIndex = null;

    function moveRow(fromIndex, toIndex) {
      const [movedRow] = rows.splice(fromIndex, 1);
      rows.splice(toIndex, 0, movedRow);
      saveAndUpdate();
    }

    function editRowName(index, nameSpan) {
      const currentName = rows[index].name;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'row-name-input';
      input.value = currentName;
      
      const saveName = () => {
        const newName = input.value.trim() || `Row ${index + 1}`;
        rows[index].name = newName;
        saveAndUpdate();
      };
      
      input.onblur = saveName;
      input.onkeydown = (e) => {
        if (e.key === 'Enter') {
          saveName();
        } else if (e.key === 'Escape') {
          updateDisplay();
        }
      };
      
      nameSpan.replaceWith(input);
      input.focus();
      input.select();
    }

    function changeCount(index, delta) {
      rows[index].count += delta;
      if (rows[index].count < 0) rows[index].count = 0;
      saveAndUpdate();
    }

    function addRow(index) {
      const newRowNum = rows.length + 1;
      rows.splice(index + 1, 0, { name: `Row ${newRowNum}`, count: 0 });
      saveAndUpdate();
    }

    function removeRow(index) {
      if (rows.length > 1) {
        rows.splice(index, 1);
        saveAndUpdate();
      }
    }

    function saveAndUpdate() {
      localStorage.setItem('rows', JSON.stringify(rows));
      updateDisplay();
    }

    updateDisplay();

    // Register service worker for offline support
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
